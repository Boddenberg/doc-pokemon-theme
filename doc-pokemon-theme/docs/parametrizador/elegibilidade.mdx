---
sidebar_position: 3
title: Elegibilidade (PA)
hide_table_of_contents: true
---

import React, {useRef, useState} from 'react';
import Mermaid from '@theme/Mermaid';

export default function ElegibilidadePA() {
  const wrapRef = useRef(null);
  const dragRef = useRef({drag:false, sx:0, sy:0});
  const [toast, setToast] = useState('');
  const toastTimer = useRef(null);

  const showToast = (msg) => {
    setToast(msg);
    if (toastTimer.current) clearTimeout(toastTimer.current);
    toastTimer.current = setTimeout(()=> setToast(''), 1800);
  };

  const mermaidRender = String.raw`%%{init: {"sequence":{"showSequenceNumbers":true,"mirrorActors":false}}}%%
sequenceDiagram
  title Elegibilidade PA

  participant MotorOfertas as Motor Ofertas
  participant ElegibilidadePA as Elegibilidade PA
  participant DisponibilidadePUC as Disponibilidade PUC

  MotorOfertas->>ElegibilidadePA: Executar(idCliente, idConta, parametrosJornada, listaCartoesCliente, dadosRendaCliente)

  Note over ElegibilidadePA: Etapa 1: Regras de triagem

  break Não foi possível carregar a parametrização da jornada, a lista de cartões do cliente ou a renda do cliente? (obrigatórios p/ PA)
    ElegibilidadePA->>MotorOfertas: Retorna não elegível
  end

  Note right of ElegibilidadePA: Verifica se o cliente possui renda suficiente para contratar o produto,<br/>caso contrário será considerado não elegível
  Note right of ElegibilidadePA: Verifica se o cliente já possui o produto,<br/>caso positivo, será considerado não elegível

  Note over ElegibilidadePA: Etapa 2: Consulta da elegibilidade
  ElegibilidadePA->>DisponibilidadePUC: Consultar elegibilidade na PUC (idCliente, idConta)
  DisponibilidadePUC-->>ElegibilidadePA: Retorna {dadosElegibilidadePUC}

  Note over ElegibilidadePA: Etapa 3: Regras pós-elegibilidade
  alt Cliente aprovado no crédito e limite disponível >= limite mínimo do produto?
    Note right of ElegibilidadePA: Ajusta o limite disponível com base no limite máximo do produto<br/>Cliente considerado elegível
  else
    Note right of ElegibilidadePA: Cliente considerado não elegível
  end

  ElegibilidadePA->>MotorOfertas: Retorna {elegibilidadePA}
`;

  const mermaidPlain = String.raw`sequenceDiagram
  title Elegibilidade PA

  participant MotorOfertas as Motor Ofertas
  participant ElegibilidadePA as Elegibilidade PA
  participant DisponibilidadePUC as Disponibilidade PUC

  MotorOfertas->>ElegibilidadePA: Executar(idCliente, idConta, parametrosJornada,<br> listaCartoesCliente, dadosRendaCliente)

  Note over ElegibilidadePA: Etapa 1: Regras de triagem

  break Não foi possível carregar a parametrização da jornada, a lista de cartões do cliente ou a renda do cliente, que são informações obrigatórias para a elegibilidade do PA?
    ElegibilidadePA->>MotorOfertas: Retorna não elegível
  end

  Note right of ElegibilidadePA: Verifica se o cliente possui renda suficiente para contratar o produto, <br> caso contrário, ele será considerado não elegível
  Note right of ElegibilidadePA: Verifica se o cliente já possui o produto, <br> caso positivo, ele será considerado não elegível

  Note over ElegibilidadePA: Etapa 2: Consulta da elegibilidade

  ElegibilidadePA->>DisponibilidadePUC: Consultar elegibilidade na PUC (idCliente, idConta)
  DisponibilidadePUC-->>ElegibilidadePA: Retorna {dadosElegibilidadePUC}

  Note over ElegibilidadePA: Etapa 3: Regras pós-elegibilidade

  alt Cliente aprovado na análise de crédito e possui limite disponível maior ou igual ao limite mínimo do produto?
    Note right of ElegibilidadePA: Ajusta o limite disponível do cliente com base no limite máximo permitido para o produto
    Note right of ElegibilidadePA: Cliente considerado elegível
  else
    Note right of ElegibilidadePA: Cliente considerado não elegível
  end

  ElegibilidadePA->>MotorOfertas: Retorna {elegibilidadePA}
`;

  const onMouseDown = (e) => {
    const el = e.currentTarget;
    dragRef.current = {drag:true, sx: e.pageX + el.scrollLeft, sy: e.pageY + el.scrollTop};
    el.style.cursor = 'grabbing';
  };
  const onMouseUp = (e) => { dragRef.current.drag = false; e.currentTarget.style.cursor = 'grab'; };
  const onMouseLeave = (e) => { dragRef.current.drag = false; e.currentTarget.style.cursor = 'grab'; };
  const onMouseMove = (e) => {
    const el = e.currentTarget;
    const s = dragRef.current;
    if (!s.drag) return;
    el.scrollLeft = s.sx - e.pageX;
    el.scrollTop  = s.sy - e.pageY;
  };

  const exportSVG = () => {
    const svg = wrapRef.current?.querySelector('svg');
    if (!svg) return;
    const xml = new XMLSerializer().serializeToString(svg);
    const blob = new Blob([xml], {type:'image/svg+xml'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'elegibilidade-pa.svg'; a.click();
    URL.revokeObjectURL(url);
  };

  const exportPNG = async (scale=1) => {
    const svg = wrapRef.current?.querySelector('svg');
    if (!svg) return;

    const vb = svg.viewBox && svg.viewBox.baseVal ? {w: svg.viewBox.baseVal.width, h: svg.viewBox.baseVal.height} : null;
    const bbox = !vb ? svg.getBBox() : null;
    const w = vb?.w || Math.ceil(bbox?.width || svg.clientWidth || 1200);
    const h = vb?.h || Math.ceil(bbox?.height || svg.clientHeight || 600);

    const canvas = document.createElement('canvas');
    canvas.width = Math.max(1, Math.floor(w * scale));
    canvas.height = Math.max(1, Math.floor(h * scale));

    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const xml = new XMLSerializer().serializeToString(svg);
    const url = URL.createObjectURL(new Blob([xml], {type:'image/svg+xml'}));
    await new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{ ctx.drawImage(img, 0, 0, canvas.width, canvas.height); URL.revokeObjectURL(url); resolve(); };
      img.src = url;
    });

    const pngUrl = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = pngUrl;
    a.download = scale === 2 ? 'elegibilidade-pa@2x.png' : 'elegibilidade-pa.png';
    a.click();
  };

  const copyMermaid = async () => {
    try {
      await navigator.clipboard.writeText(mermaidPlain);
      showToast('Mermaid copiado ✓');
    } catch {}
  };

  return (
    <>
      <style>{`
        .diagram-card {
          position: relative;
          background: linear-gradient(135deg,#e3f2fd 0%,#e8f5e9 50%,#fff3e0 100%);
          border-radius: 20px;
          padding: 1.25rem;
          box-shadow: 0 8px 24px rgba(0,0,0,.08);
          border: 1px solid rgba(13,71,161,.12);
        }
        .diagram-frame {
          background: rgba(255,255,255,.75);
          backdrop-filter: blur(6px);
          border-radius: 16px;
          border: 1px solid #e0e0e0;
          padding: 1rem;
          overflow: auto;
        }
        .diagram-frame svg { max-width: 100%; height: auto; }
        .diagram-actions {
          display: flex;
          justify-content: flex-end;
          gap: .5rem;
          margin-top: .75rem;
        }
        .btn {
          appearance: none;
          border: 1px solid transparent;
          padding: .6rem .9rem;
          border-radius: .75rem;
          font-weight: 600;
          font-size: .95rem;
          cursor: pointer;
          transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
          box-shadow: 0 6px 16px rgba(0,0,0,.08);
          outline: none;
        }
        .btn:focus { box-shadow: 0 0 0 3px rgba(124,58,237,.25); }
        .btn:hover { transform: translateY(-1px); filter: brightness(1.02); }
        .btn-primary {
          color: #fff;
          background: linear-gradient(135deg,#7c3aed 0%,#0ea5e9 100%);
          border: 1px solid rgba(255,255,255,.18);
        }
        .btn-outline {
          color: #0d47a1;
          background: rgba(255,255,255,.85);
          border: 1px solid rgba(13,71,161,.2);
        }
        .toast {
          position: absolute;
          right: 12px;
          bottom: 12px;
          padding: .45rem .7rem;
          border-radius: 999px;
          background: rgba(29,35,50,.92);
          color: #fff;
          font-weight: 700;
          font-size: .9rem;
          box-shadow: 0 8px 22px rgba(0,0,0,.2);
          opacity: 0;
          transform: translateY(6px);
          pointer-events: none;
          transition: opacity .2s ease, transform .2s ease;
        }
        .toast[data-show="1"] { opacity: 1; transform: translateY(0); }
      `}</style>

      <div className="diagram-card">
        <div
          ref={wrapRef}
          className="diagram-frame"
          style={{cursor:'grab'}}
          onMouseDown={onMouseDown}
          onMouseUp={onMouseUp}
          onMouseLeave={onMouseLeave}
          onMouseMove={onMouseMove}
        >
          <Mermaid value={mermaidRender} />
        </div>

        <div className="diagram-actions">
          <button className="btn btn-primary" onClick={exportSVG}>Exportar SVG</button>
          <button className="btn btn-outline" onClick={()=>exportPNG(1)}>PNG</button>
          <button className="btn btn-outline" onClick={()=>exportPNG(2)}>PNG HD</button>
          <button className="btn btn-outline" onClick={copyMermaid}>Copiar Mermaid</button>
        </div>

        <div className="toast" data-show={toast ? '1' : '0'}>
          {toast}
        </div>
      </div>
    </>
  );
}
